<template>
  <div
    style="font-family: 'Racing Sans One', cursive; font-size:70px"
    class="has-text-black has-text-centered	"
  >
    TOKEN EDITOR
  </div>
  <div style="margin-top: 30px">
    <article v-if="editedTokenAddress" class="message is-black">
      <div class="message-body">
        Success! Take a look at your edited token:
        <a :href="tokenLink" target="_blank" rel="noopener noreferrer">{{
          editedTokenAddress
        }}</a>
      </div>
    </article>
    <article v-else-if="errorMessage" class="message is-danger">
      <div class="message-body">
        {{ errorMessage }}
      </div>
    </article>
    <div class="field">
      <label class="label">Fee payer*</label>
      <div class="control">
        <input
          v-model="payerSecret"
          class="input is-black"
          type="text"
          placeholder="Secret (seed phrase or comma-separated array of 64 numbers)"
        />
      </div>
      <p class="help">
        Your secret is NOT saved NOR sent anywhere. It's only used to pay the
        token editing tx fee.
      </p>
    </div>
    <div class="field">
      <label class="label">Token mint address*</label>
      <div class="control">
        <input
          v-model="tokenAddress"
          class="input is-black"
          type="text"
          placeholder="Token address e.g. GsbwXfJraMomNxBcjYLcG3mxkBUiyWXAB32fGbSMQRdW"
        />
      </div>
    </div>
    <div
      style="display: flex; margin-top: 35px"
      class="is-justify-content-center"
    >
      <p><strong> Edit mint authority</strong></p>
      <Toggle v-model:checked="editingFreezeAuthority" class="ml-2" />
      <p class="ml-2"><strong> Edit freeze authority</strong></p>
    </div>
    <div class="field mt-5">
      <label class="label"
        >Current
        {{ editingFreezeAuthority ? "freeze" : "mint" }} authority*</label
      >
      <div class="control">
        <input
          v-model="currentAuthority"
          class="input is-black"
          type="text"
          placeholder="Secret (seed phrase or comma-separated array of 64 numbers)"
        />
        <p class="help">
          Your secret is NOT saved NOR sent anywhere. It's only used to sign the
          authority change request.
        </p>
      </div>
    </div>

    <div class="field">
      <label class="label"
        >New {{ editingFreezeAuthority ? "freeze" : "mint" }} authority</label
      >
      <div class="control">
        <input
          v-model="newAuthority"
          class="input is-black"
          type="text"
          placeholder="Public Key String e.g. GsbwXfJraMomNxBcjYLcG3mxkBUiyWXAB32fGbSMQRdW"
        />
      </div>
      <p class="help">
        You can leave this field empty to remove the authority from the token.
      </p>
    </div>
    <div style="display: flex" class="control is-justify-content-center mt-5">
      <button
        :class="{ 'is-loading': editingToken }"
        class="button is-black"
        @click="onEditToken"
      >
        Edit token
      </button>
    </div>
  </div>
</template>

<script lang="ts">
import { ref } from "vue";
import { editToken } from "@/solana/token";
import { chosenCluster } from "@/solana/connection";
import { AuthorityType } from "@solana/spl-token";
import Toggle from "@/components/util/Toggle.vue";
import * as SolanaErrorHandler from "@/solana/SolanaErrorHandler";

export default {
  components: {
    Toggle
  },
  setup() {
    const payerSecret = ref("");
    const tokenAddress = ref("");
    const editingFreezeAuthority = ref(false);
    const currentAuthority = ref("");
    const newAuthority = ref("");
    const editedTokenAddress = ref("");
    const tokenLink = ref("");
    const editingToken = ref(false);
    const errorMessage = ref("");

    const onEditToken = async () => {
      tokenLink.value = "";
      editedTokenAddress.value = "";
      editingToken.value = true;
      try {
        const authorityType: AuthorityType = editingFreezeAuthority.value
          ? "FreezeAccount"
          : "MintTokens";
        await editToken(
          payerSecret.value,
          tokenAddress.value,
          newAuthority.value,
          currentAuthority.value,
          authorityType
        );
        editedTokenAddress.value = tokenAddress.value;
        tokenLink.value = `https://explorer.solana.com/address/${tokenAddress.value}?cluster=${chosenCluster.value}`;
      } catch (err) {
        errorMessage.value = SolanaErrorHandler.getErrorMessage(err);
      }

      editingToken.value = false;
    };

    return {
      payerSecret,
      newAuthority,
      currentAuthority,
      editingFreezeAuthority,
      tokenAddress,
      editedTokenAddress,
      onEditToken,
      editingToken,
      tokenLink,
      errorMessage
    };
  }
};
</script>
